# Using CTE with UPDATE
create table t1 (a int, b int) engine=innodb;
insert into t1 values(1,2),(3,4);
create table t2 select * from t1;
set autocommit=0;
with t as (select a, b from t1) update t1, t set t.a=t.a+10;
ERROR HY000: The target table t of the UPDATE is not updatable
update t1, (select a,b from t1) as t set t.a=t.a+10;
ERROR HY000: The target table t of the UPDATE is not updatable
explain with t as (select a+2 as a, b from t1) update t1, t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	
with t as (select a+2 as a, b from t1) update t1, t set t1.a=t.a+10 where t1.a=t.a;
select * from t1;
a	b
1	2
13	4
rollback;
explain update t1, (select a+2 as a, b from t1) as t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	
update t1, (select a+2 as a, b from t1) as t set t1.a=t.a+10 where t1.a=t.a;
select * from t1;
a	b
1	2
13	4
rollback;
explain with t as (select a+2 as a, b from t2) update t1, t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
2	DERIVED	t2	ALL	NULL	NULL	NULL	NULL	2	
with t as (select a+2 as a, b from t2) update t1, t set t1.a=t.a+10 where t1.a=t.a;
select * from t1;
a	b
1	2
13	4
rollback;
explain update t1, (select a+2 as a,b from t2) as t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
2	DERIVED	t2	ALL	NULL	NULL	NULL	NULL	2	
update t1, (select a+2 as a,b from t2) as t set t1.a=t.a+10 where t1.a=t.a;
select * from t1;
a	b
1	2
13	4
rollback;
explain with t as (select a+2 as a, sum(b) from t1 group by t1.a) update t1, t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	Using temporary; Using filesort
with t as (select a+2 as a, sum(b) from t1 group by t1.a) update t1, t set t1.a=t.a+10 where t1.a=t.a;
select * from t1;
a	b
1	2
13	4
rollback;
explain update t1, (select a+2 as a, sum(b) from t1 group by t1.a) t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	Using temporary; Using filesort
update t1, (select a+2 as a, sum(b) from t1 group by t1.a) t set t1.a=t.a+10 where t1.a=t.a;
select * from t1;
a	b
1	2
13	4
rollback;
# Single-table syntax
explain with t as (select a+2 as a, b from t2) update t1
set t1.a=(select t.a+10 from t where t1.a=t.a limit 1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	
3	DEPENDENT SUBQUERY	t2	ALL	NULL	NULL	NULL	NULL	2	Using where
with t as (select a+2 as a, b from t2) update t1
set t1.a=(select t.a+10 from t where t1.a=t.a limit 1);
select * from t1;
a	b
NULL	2
13	4
rollback;
explain update t1 set t1.a=(select t.a+10 from 
(select a+2 as a, b from t2) as t where t1.a=t.a limit 1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	
2	DEPENDENT SUBQUERY	t2	ALL	NULL	NULL	NULL	NULL	2	Using where
update t1 set t1.a=(select t.a+10 from 
(select a+2 as a, b from t2) as t where t1.a=t.a limit 1);
select * from t1;
a	b
NULL	2
13	4
rollback;
# CTE in subquery of WHERE clause
explain with cte As (select a+2 as a, b from t1)
update t1, cte set t1.a=t1.a+10 where t1.a=(select a from cte limit 1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ALL	NULL	NULL	NULL	NULL	2	
3	SUBQUERY	<derived4>	ALL	NULL	NULL	NULL	NULL	2	
4	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	
with cte As (select a+2 as a, b from t1)
update t1, cte set t1.a=t1.a+10 where t1.a=(select a from cte limit 1);
select * from t1;
a	b
1	2
13	4
rollback;
explain update t1 set t1.a=t1.a+10 where t1.a=
(with cte AS (select a+2 as a,b from t1) select a from cte limit 1);
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
3	SUBQUERY	<derived2>	ALL	NULL	NULL	NULL	NULL	2	
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	
update t1 set t1.a=t1.a+10 where t1.a=
(with cte AS (select a+2 as a,b from t1) select a from cte limit 1);
select * from t1;
a	b
1	2
13	4
rollback;
# Multiple references to same cte
explain with cte as (select a+2 as a, b from t2)
update t1, cte, cte as cte2 set t1.a=cte.a+10 where t1.a=cte.a and cte.b=cte2.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
1	PRIMARY	<derived3>	ref	key0	key0	5	cte.b	2	
3	DERIVED	t2	ALL	NULL	NULL	NULL	NULL	2	
2	DERIVED	t2	ALL	NULL	NULL	NULL	NULL	2	
with cte as (select a+2 as a, b from t2)
update t1, cte, cte as cte2 set t1.a=cte.a+10 where t1.a=cte.a and cte.b=cte2.b;
select * from t1;
a	b
1	2
13	4
rollback;
explain update t1, (select a+2 as a, b from t2) as c1, (select a+2 as a, b from t2)
as c2 set t1.a=c1.a+10 where t1.a=c1.a and c1.b=c2.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	Using where
1	PRIMARY	<derived3>	ref	key0	key0	5	c1.b	2	
3	DERIVED	t2	ALL	NULL	NULL	NULL	NULL	2	
2	DERIVED	t2	ALL	NULL	NULL	NULL	NULL	2	
update t1, (select a+2 as a, b from t2) as c1, (select a+2 as a, b from t2)
as c2 set t1.a=c1.a+10 where t1.a=c1.a and c1.b=c2.b;
select * from t1;
a	b
1	2
13	4
rollback;
# Analyze stmt + CTE
analyze with t as (select a+2 as a, b from t1) update t1, t set t1.a=t.a+10 where t1.a=t.a;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	r_rows	filtered	r_filtered	Extra
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	2	2.00	100.00	100.00	Using where
1	PRIMARY	<derived2>	ref	key0	key0	9	test.t1.a	2	0.50	100.00	100.00	Using where
2	DERIVED	t1	ALL	NULL	NULL	NULL	NULL	2	2.00	100.00	100.00	
rollback;
analyze format=json with t as (select a+2 as a, b from t1) update t1, t set t1.a=t.a+10 where t1.a=t.a;
ANALYZE
{
  "query_block": {
    "select_id": 1,
    "r_loops": 1,
    "r_total_time_ms": "REPLACED",
    "table": {
      "table_name": "t1",
      "access_type": "ALL",
      "r_loops": 1,
      "rows": 2,
      "r_rows": 2,
      "r_table_time_ms": "REPLACED",
      "r_other_time_ms": "REPLACED",
      "filtered": 100,
      "r_filtered": 100,
      "attached_condition": "t1.a is not null"
    },
    "table": {
      "table_name": "<derived2>",
      "access_type": "ref",
      "possible_keys": ["key0"],
      "key": "key0",
      "key_length": "9",
      "used_key_parts": ["a"],
      "ref": ["test.t1.a"],
      "r_loops": 2,
      "rows": 2,
      "r_rows": 0.5,
      "r_table_time_ms": "REPLACED",
      "r_other_time_ms": "REPLACED",
      "filtered": 100,
      "r_filtered": 100,
      "attached_condition": "t1.a = t.a",
      "materialized": {
        "query_block": {
          "select_id": 2,
          "r_loops": 1,
          "r_total_time_ms": "REPLACED",
          "table": {
            "table_name": "t1",
            "access_type": "ALL",
            "r_loops": 1,
            "rows": 2,
            "r_rows": 2,
            "r_table_time_ms": "REPLACED",
            "r_other_time_ms": "REPLACED",
            "filtered": 100,
            "r_filtered": 100
          }
        }
      }
    }
  }
}
rollback;
set autocommit=1;
drop table t1,t2;
