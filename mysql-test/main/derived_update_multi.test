--echo # Test file for multi-table update queries

--echo # Initialization of Tables
create table t1 (a int, b int);
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
select * from t1;
create table t2 (c int, d int);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);
select * from t1;

--echo # Following queries tries different way to update base tables (t1, t2)
--echo # by using different combinations of DTs, Base Tables, Views and where clauses.

--echo # Updating DT, Tables used - base table inside DT + Base table
update (select * from t1) dt1, t2 set a=0;
select * from t1;

--echo # ... Adding where clause inside specification of DT:
update (select * from t1 where b>10) dt1, t2 set b=4;
select * from t1;

--echo # ... Adding where clause outside:
update (select * from t1 where b>3) dt1, t2 set a=5 where b>4;
select * from t1;

--echo # Updating Base Table, Tables used - DT & base:
update (select * from t1) dt1, t2 set c=1;
select * from t2;

--echo # ... Adding where clause outside:
update (select * from t1) dt1, t2 set c=2 where d>10;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing two base tables:
update (select * from t1, t2) dt1 set a=0;
select * from t1;

--echo # ... Adding where clause inside specification:
update (select * from t1, t2 where b>3) dt1 set a=3;
select * from t1;

--echo # ... Adding where clause outside and removing from inside:
update (select * from t1, t2) dt1 set a=5 where b<4;
select * from t1;

--echo # ... Adding where clause to inside and outside:
update (select * from t1, t2 where a>3 and c<10) dt1 set a=0 where a>4;
select * from t1;

--echo # Updating 2nd BT:
update (select * from t1, t2) dt1 set c=2;
select * from t2;

--echo # ... Adding where clause inside specification of DT:
update (select * from t1, t2 where d<10) dt1 set c=3;
select * from t2;

--echo # ... Adding where clause outside:
update (select * from t1, t2) dt1 set c=6 where a>1 and d>=10;
select * from t2;

--echo # ... Adding where clause inside and outside:
update (select * from t1, t2 where a>3 and c<5) dt1 set c=9 where d>4;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing DT with two base tables:
update (select * from (select * from t1, t2) dt2) dt1 set a=0;
select * from t1;

--echo # ... Adding where clause inside specification:
update (select * from (select * from t1, t2) dt2 where b>3) dt1 set a=3;
select * from t1;

--echo # ... Adding where clause outside and removing from inside:
update (select * from (select * from t1, t2) dt2) dt1 set a=5 where b<4;
select * from t1;

--echo # ... Adding where clause to inside and outside:
update (select * from (select * from t1, t2) dt2 where a>3 and c<10) dt1 set a=0 where a>4;
select * from t1;

--echo # Updating 2nd BT:
update (select * from (select * from t1, t2) dt2) dt1 set c=2;
select * from t2;

--echo # ... Adding where clause inside specification of DT:
update (select * from (select * from t1, t2) dt2 where d<10) dt1 set c=3;
select * from t2;

--echo # ... Adding where clause outside:
update (select * from (select * from t1, t2) dt2) dt1 set c=6 where a>1 and d>=10;
select * from t2;

--echo # ... Adding where clause inside and outside:
update (select * from (select * from t1, t2) dt2 where a>3 and c<5) dt1 set c=9 where d>4;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT with single base table inside another DT + base table
update (select * from (select * from t1) dt1) dt2, t2 set a=0;
select * from t1;

--echo # ... Adding where clause inside specification of dt2:
update (select * from (select * from t1) dt1 where b>5) dt2, t2 set a=9;
select * from t1;

--echo # ... Adding where clause inside and outside:
update (select * from (select * from t1) dt1 where b<5) dt2, t2 set a=7 where b>1;
select * from t1;

--echo # Updating BT:
update (select * from (select * from t1) dt1) dt2, t2 set c=1;
select * from t2;

--echo # ... Adding where clause inside specification of dt2:
update (select * from (select * from t1) dt1 where a>4) dt2, t2 set c=3;
select * from t2;

--echo # ... Adding where clause outside:
update (select * from (select * from t1) dt1 where a>4) dt2, t2 set c=4 where d<5;
select * from t2;

--echo # Switching places of DT and BT:
--echo # Updating BT 't1':
update t1, (select * from (select * from t2) dt1 where c>2) dt2 set a=0;
select * from t1;

--echo # ... Adding where clause inside specification of dt2:
update t1, (select * from (select * from t2) dt1 where c<4) dt2 set a=0 where b>2;
select * from t1;

--echo # Updating DT:
update t1, (select * from (select * from t2) dt1 where c>2) dt2 set c=1;
select * from t2;

--echo # ... Adding where clause outside:
update t1, (select * from (select * from t2) dt1 where c<2) dt2 set c=3 where d>4;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Pattern: Not allowed queries follow by followed ones:
--echo # Updating DT with non-updatable columns inside specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from t1) dt1, t2 set a1=0;
update (select a+1 as a1, b from t1) dt1, t2 set b=0;
select * from t1;

--echo # ... Adding where clause inside specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from t1 where b>0) dt1, t2 set a1=0;
update (select a+1 as a1, b from t1 where b>0) dt1, t2 set b=0;
select * from t1;

--echo # ...Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from t1 where b>0) dt1, t2 set a1=0 where b>1;
update (select a+1 as a1, b from t1 where b>0) dt1, t2 set b=0 where b>1;
select * from t1;

--echo # Updating BT:
update (select a+1 as a1, b from t1 where b>0) dt1, t2 set c=1 where d>2;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Two base tables inside single DT with non updatable columns
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c from t1, t2) dt1 set a1=0;
update (select a+1 as a1, c from t1, t2) dt1 set c=0;
select * from t2;

--echo # ... Adding where clause inside the specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c from t1, t2 where b>3 and c<10) dt1 set a1=0;
update (select a+1 as a1, c from t1, t2 where b>3 and c<10) dt1 set c=2;
select * from t2;

--echo # ... Adding where clause outside as well:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b, c from t1, t2) dt1 set a1=0 where b>1 and c<10;
update (select a+1 as a1, b, c from t1, t2) dt1 set c=0 where b>1 and c<10;
select * from t2;

--echo # Updating multiple columns:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c, d from t1, t2 where b>3 and c<10) dt1 set a1=0, c=2 where d>4;
update (select a+1 as a1, c, d from t1, t2 where b>3 and c<10) dt1 set c=2, d=3 where d>4;
select * from t2;

--echo # Using non-updatable column from 2nd BT:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from t1, t2) dt1 set c1=2;
update (select a, c+1 as c1, d from t1, t2) dt1 set d=2;
select * from t2;

--echo # ... Adding where clause inside specification of dt1:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from t1, t2 where a>3 and d<10) dt1 set c1=2;
update (select a, c+1 as c1, d from t1, t2 where a>3 and d<10) dt1 set d=0;
select * from t2;

--echo # ... Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from t1, t2) dt1 set c1=2 where a>1 and d<10;
update (select a, c+1 as c1, d from t1, t2) dt1 set d=2 where a>1 and d<10;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # DT with two base tables inside another DT with non-updatable columns
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c from (select * from t1, t2) dt2) dt1 set a1=0;
update (select a+1 as a1, c from (select * from t1, t2) dt2) dt1 set c=0;
select * from t2;

--echo # ... Adding where clause inside the specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c from (select * from t1, t2) dt2 where b>3 and c<10) dt1 set a1=0;
update (select a+1 as a1, c from (select * from t1, t2) dt2 where b>3 and c<10) dt1 set c=2;
select * from t2;

--echo # ... Adding where clause outside as well:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b, c from (select * from t1, t2) dt2) dt1 set a1=0 where b>1 and c<10;
update (select a+1 as a1, b, c from (select * from t1, t2) dt2) dt1 set c=0 where b>1 and c<10;
select * from t2;

--echo # Updating multiple columns:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c, d from (select * from t1, t2) dt2 where b>3 and c<10) dt1 set a1=0, c=2 where d>4;
update (select a+1 as a1, c, d from (select * from t1, t2) dt2 where b>3 and c<10) dt1 set c=2, d=3 where d>4;
select * from t2;

--echo # Using non-updatable column from 2nd BT:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from (select * from t1, t2) dt2) dt1 set c1=2;
update (select a, c+1 as c1, d from (select * from t1, t2) dt2) dt1 set d=2;
select * from t2;

--echo # ... Adding where clause inside specification of dt1:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from (select * from t1, t2) dt2 where a>3 and d<10) dt1 set c1=2;
update (select a, c+1 as c1, d from (select * from t1, t2) dt2 where a>3 and d<10) dt1 set d=0;
select * from t2;

--echo # ... Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from (select * from t1, t2) dt2) dt1 set c1=2 where a>1 and d<10;
update (select a, c+1 as c1, d from (select * from t1, t2) dt2) dt1 set d=2 where a>1 and d<10;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # DT with single base table inside another DT with non-updatable columns & base table:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from (select * from t1) dt2) dt1, t2 set a1=0;
update (select a+1 as a1, b from (select * from t1) dt2) dt1, t2 set b=0;
select * from t1;

--echo # ... Adding where clause inside specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from (select * from t1) dt2 where b>0) dt1, t2 set a1=0;
update (select a+1 as a1, b from (select * from t1) dt2 where b>0) dt1, t2 set b=0;
select * from t1;

--echo # ...Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from (select * from t1) dt2 where b>0) dt1, t2 set a1=0 where b>1;
update (select a+1 as a1, b from (select * from t1) dt2 where b>0) dt1, t2 set b=0 where b>1;
select * from t1;

--echo # Updating BT:
update (select a+1 as a1, b from (select * from t1) dt2 where b>0) dt1, t2 set c=1 where d>2;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Initialization of views:
create view v1 as (select * from t1);
select * from v1;
create view v2 as (select * from t2);
select * from v2;


--echo # Updating DT containing a view & BT:
update (select * from v1) dt1, t2 set a=0;
select * from v1;

--echo # ... Adding where clause inside specification of dt1:
update (select * from v1 where b>3) dt1, t2 set a=2;
select * from v1;

--echo # ... Adding where clause outside:
update (select * from v1 where b>2) dt1, t2 set a=3 where a>1;
select * from v1;

--echo # Updating multiple columns:
update (select * from v1 where a>0) dt1, t2 set c=1, d=3 where a>1;
select * from v2;

--echo # ... Adding second where clause
update (select * from v1 where a>0) dt1, t2 set c=3, d=4 where a>1 and c<11;
select * from v1;

--echo # Switching places and using another view:
update t1, (select * from v2) dt1 set c=0;
select * from v2;

--echo # ... Adding where clause inside specification of dt1:
update t1, (select * from v2 where c>2) dt1 set c=3;
select * from v1;

--echo # ... Adding where clause outside:
update t1, (select * from v2 where c>2) dt1 set c=0 where a>1;
select * from v1;

--echo # Updating multiple columns of BT:
update t1, (select * from v2 where c>2) dt1 set a=0, b=1 where a>1;
select * from v1;
select * from v2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing two views:
update (select * from v1, v2) dt1 set a=0;
select * from v1;

--echo # ... Adding where clause inside specification:
update (select * from v1, v2 where b>3) dt1 set a=3;
select * from v1;

--echo # ... Adding where clause outside and removing from inside:
update (select * from v1, v2) dt1 set a=5 where b<4;
select * from v1;

--echo # ... Adding where clause to inside and outside:
update (select * from v1, v2 where a>3 and c<10) dt1 set a=0 where a>4;
select * from v1;

--echo # Updating 2nd BT:
update (select * from v1, v2) dt1 set c=2;
select * from v2;

--echo # ... Adding where clause inside specification of DT:
update (select * from v1, v2 where d<10) dt1 set c=3;
select * from v2;

--echo # ... Adding where clause outside:
update (select * from v1, v2) dt1 set c=6 where a>1 and d>=10;
select * from v2;

--echo # ... Adding where clause inside and outside:
update (select * from v1, v2 where a>3 and c<5) dt1 set c=9 where d>4;
select * from v2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing a view which contains two BTs:
create view v3 as (select * from t1, t2);
select * from v3;

update (select * from v3) dt1 set a=0;
select * from t1;

--echo # ... Adding where clause inside specification:
update (select * from v3 where b>3) dt1 set a=3;
select * from t1;

--echo # ... Adding where clause outside and removing from inside:
update (select * from v3) dt1 set a=5 where b<4;
select * from t1;

--echo # ... Adding where clause to inside and outside:
update (select * from v3 where a>3 and c<10) dt1 set a=0 where a>4;
select * from t1;

--echo # Updating 2nd BT:
update (select * from v3) dt1 set c=2;
select * from t2;

--echo # ... Adding where clause inside specification of DT:
update (select * from v3 where d<10) dt1 set c=3;
select * from t2;

--echo # ... Adding where clause outside:
update (select * from v3) dt1 set c=6 where a>1 and d>=10;
select * from t2;

--echo # ... Adding where clause inside and outside:
update (select * from v3 where a>3 and c<5) dt1 set c=9 where d>4;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing a view(v1) with non-updatable columns & another view (v2):
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from v1) dt1, v2 set a1=0;
update (select a+1 as a1, b from v1) dt1, v2 set b=0;
select * from v1;

--echo # ... Adding where clause inside specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from v1 where b>0) dt1, v2 set a1=0;
update (select a+1 as a1, b from v1 where b>0) dt1, v2 set b=0;
select * from v1;

--echo # ...Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from v1 where b>0) dt1, v2 set a1=0 where b>1;
update (select a+1 as a1, b from v1 where b>0) dt1, v2 set b=0 where b>1;
select * from v1;

--echo # Updating BT:
update (select a+1 as a1, b from v1 where b>0) dt1, v2 set c=1 where d>2;
select * from v2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing a view(v1) with non-updatable columns & BT (t2):
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from v1) dt1, t2 set a1=0;
update (select a+1 as a1, b from v1) dt1, t2 set b=0;
select * from v1;

--echo # ... Adding where clause inside specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from v1 where b>0) dt1, t2 set a1=0;
update (select a+1 as a1, b from v1 where b>0) dt1, t2 set b=0;
select * from v1;

--echo # ...Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from v1 where b>0) dt1, t2 set a1=0 where b>1;
update (select a+1 as a1, b from v1 where b>0) dt1, t2 set b=0 where b>1;
select * from v1;

--echo # Updating BT:
update (select a+1 as a1, b from v1 where b>0) dt1, t2 set c=1 where d>2;
select * from t2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Updating DT containing a BT(t1) with non-updatable columns & a view (v2):
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from t1) dt1, v2 set a1=0;
update (select a+1 as a1, b from t1) dt1, v2 set b=0;
select * from t1;

--echo # ... Adding where clause inside specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from t1 where b>0) dt1, v2 set a1=0;
update (select a+1 as a1, b from t1 where b>0) dt1, v2 set b=0;
select * from t1;

--echo # ...Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b from t1 where b>0) dt1, v2 set a1=0 where b>1;
update (select a+1 as a1, b from t1 where b>0) dt1, v2 set b=0 where b>1;
select * from t1;

--echo # Updating BT:
update (select a+1 as a1, b from t1 where b>0) dt1, v2 set c=1 where d>2;
select * from v2;


--echo # Reseting base tables:
delete from t1, t2;
insert into t1 values (1,2),(33,1),(3,3),(11,12),(8,7);
insert into t2 values (2,4),(9,9),(5,4),(10,111),(7,10);


--echo # Two views inside a DT(dt1) with non updatable columns:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c from v1, v2) dt1 set a1=0;
update (select a+1 as a1, c from v1, v2) dt1 set c=0;
select * from v2;

--echo # ... Adding where clause inside the specification:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c from v1, v2 where b>3 and c<10) dt1 set a1=0;
update (select a+1 as a1, c from v1, v2 where b>3 and c<10) dt1 set c=2;
select * from v2;

--echo # ... Adding where clause outside as well:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, b, c from v1, v2) dt1 set a1=0 where b>1 and c<10;
update (select a+1 as a1, b, c from v1, v2) dt1 set c=0 where b>1 and c<10;
select * from v2;

--echo # Updating multiple columns:
--error ER_NONUPDATEABLE_COLUMN
update (select a+1 as a1, c, d from v1, v2 where b>3 and c<10) dt1 set a1=0, c=2 where d>4;
update (select a+1 as a1, c, d from v1, v2 where b>3 and c<10) dt1 set c=2, d=3 where d>4;
select * from v2;

--echo # Using non-updatable column from 2nd view:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from v1, v2) dt1 set c1=2;
update (select a, c+1 as c1, d from v1, v2) dt1 set d=2;
select * from v2;

--echo # ... Adding where clause inside specification of dt1:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from v1, v2 where a>3 and d<10) dt1 set c1=2;
update (select a, c+1 as c1, d from v1, v2 where a>3 and d<10) dt1 set d=0;
select * from v2;

--echo # ... Adding where clause outside:
--error ER_NONUPDATEABLE_COLUMN
update (select a, c+1 as c1, d from v1, v2) dt1 set c1=2 where a>1 and d<10;
update (select a, c+1 as c1, d from v1, v2) dt1 set d=2 where a>1 and d<10;
select * from t2;

--echo # Clearing
drop view v1, v2, v3;
drop table t1, t2;