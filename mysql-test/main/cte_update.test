--echo # Test file for CTE UPDATE queries:

create table t1 (a int) engine=myisam;
insert into t1 values (3), (7), (1);
with cte1 as (select a from t1) update cte1 set a=10;
select * from t1;
with cte1 as (select * from t1) update cte1 set a=14;
select * from t1;
with cte1 as (select * from t1) update cte1 set cte1.a=18 limit 1;
select * from t1;
with cte1 as (select * from t1) update cte1 set cte1.a=2 where a<18;
select * from t1;
with cte1 as (select * from (select * from t1) dt1)
update cte1 set cte1.a=22 where a>18;
select * from t1;
with cte1 as (select * from (select * from t1) dt1 where dt1.a > 17)
update cte1 set cte1.a=24;
select * from t1;
create view v1 as select * from t1 where t1.a < 10;
create view v2 as select * from v1;
update v2 set a=6;
select * from t1;
with cte1 as (select * from (select * from t1 where t1.a > 2) dt1 where dt1.a < 24)
update cte1 set cte1.a=4 limit 1;
select * from t1;
drop view v1, v2;
drop table t1;

--echo # Initialization of base tables:
create table t1 (a int);
insert into t1 values (1),(2),(3),(4),(7),(10);
create table t2 (b int);
insert into t2 values (4),(7),(1),(3),(11);
select * from t1;
select * from t2;

--echo # Updating simple CTEs:
with cte1 as (select * from t1 where a <2) update cte1 set a=0;
select * from t1;

--echo # ... Adding where clause outside:
with cte1 as (select * from t1 where a>2) update cte1 set a=0 where a<10;
select * from t1;

--echo # Updating CTE containing another CTE:
with cte1 as (select * from (select * from t1) dt1) update cte1 set a=1 where a>2;
select * from t1;

--echo # ... Adding where clause outside:
with cte1 as (select * from (select * from t1) dt1 where a>1)
update cte1 set a=9 where a>2;
select * from t1;

--echo # Update CTE containing next DT:
with cte1 as (select * from (select * from (select * from t1) dt1) dt2)
update cte1 set a=2 where a>7;
select * from t1;

--echo # ... Adding where clause inside specification of cte1:
with cte1 as (select * from (select * from (select * from t1) dt1) dt2 where a<8)
update cte1 set a=2 where a>3;
select * from t1;

with cte1 as (select * from (select * from (select * from t1) dt1 where a>1) dt2 where a<11)
update cte1 set a=3 where a>6;
select * from t1;

--echo # Updating Nested CTE:
with cte1 as (select * from t1),
cte2 as (select * from cte1) update cte2 set a=9 where a>5;
select * from t1;

--echo # ... Adding where clause inside specification of cte1 and cte2:
with cte1 as (select * from t1 where a>2),
cte2 as (select * from cte1 where a>3) update cte2 set a=9 where a<9;
select * from t1;

--echo # Increasing nesting of above query:
with cte1 as (select * from (select * from t1) dt1),
cte2 as (select * from cte1) update cte2 set a=9 where a>3;
select * from t1;

--echo # ... Adding where clause in specification:
with cte1 as (select * from (select * from t1) dt1 where a>2),
cte2 as (select * from cte1 where a>3) update cte2 set a=9 where a<9;
select * from t1;

--echo # Utilizing views instead of base table for above queries:
create view v1 as (select * from t1);
select * from v1;

--echo # Updating CTEs containing simple views:
with cte1 as (select * from v1) update cte1 set a=20 where a>5;
select * from t1;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v1 where a>3) update cte1 set a=0 where a<9;
select * from t1;

--echo # ... Adding 'v1' inside a DT:
with cte1 as (select * from (select * from v1) dt1) update cte1 set a=0 where a<7;
select * from t1;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from (select * from v1) dt1 where a>2) update cte1 set a=0 where a<7;
select * from t1;

--echo # Multiple CTE elements:
with cte1 as (select * from v1), cte2 as (select * from cte1)
update cte2 set a=11 where a>5;
select * from t1;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v1 where a<7), cte2 as (select * from cte1)
update cte2 set a=11 where a>2;
select * from t1;

--echo # ... Adding where clause in specification of cte2:
with cte1 as (select * from v1 where a<7), cte2 as (select * from cte1 where a>3)
update cte2 set a=11 where a>2;
select * from t1;

--echo # Replacing 'v1' for 'v2' which contains DT from above queries:
create view v2 as (select * from (select * from t2) dt1 where b < 10);
select * from v2;

--echo # Updating CTE containing 'v2':
with cte1 as (select * from v2) update cte1 set b=20 where b>5;
select * from t2;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v2 where b>3) update cte1 set b=0 where b<9;
select * from t2;

--echo # Embedding v2 inside a DT:
with cte1 as (select * from (select * from v2) dt1) update cte1 set b=0 where b<7;
select * from t2;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from (select * from v2) dt1 where b>2) update cte1 set b=0 where b<7;
select * from t2;

--echo # ... Adding where clause in specification of dt1:
with cte1 as (select * from (select * from v2 where b>1) dt1 where b>2) update cte1 set b=0 where b<7;
select * from t2;

--echo # Multiple elements of CTE:
with cte1 as (select * from v2), cte2 as (select * from cte1)
update cte2 set b=11 where b>5;
select * from t2;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v2 where b<15), cte2 as (select * from cte1)
update cte2 set b=11 where b>5;
select * from t2;

--echo # ... Adding where clause in specification of cte2:
with cte1 as (select * from v2 where b<15), cte2 as (select * from cte1 where b>3)
update cte2 set b=11 where b>2;
select * from t2;


--echo # Reseting base table t1:
delete from t1;
insert into t1 values (1),(2),(3),(4),(7),(10);


--echo # Utilizing Nested views:
create view v3 as (select * from v1 where a<7);
select * from v3;

--echo # Updating CTE containg a nested view in it:
with cte1 as (select * from v3) update cte1 set a=20 where a>1;
select * from t1;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v3 where a>3) update cte1 set a=0 where a<9;
select * from t1;

--echo # ... Embedding v3 inside a DT:
with cte1 as (select * from (select * from v3) dt1) update cte1 set a=0 where a<4;
select * from t1;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from (select * from v3) dt1 where a>2) update cte1 set a=0 where a<4;
select * from t1;

--echo # Multiple CTE elements containing 'v3':
with cte1 as (select * from v3), cte2 as (select * from cte1)
update cte2 set a=11 where a<5;
select * from t1;

--echo # ... Adding where clause in specification of cte2:
with cte1 as (select * from v3), cte2 as (select * from cte1 where a>1)
update cte2 set a=11 where a<5;
select * from t1;
--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v3 where a>0), cte2 as (select * from cte1 where a>1)
update cte2 set a=11 where a<5;
select * from t1;


--echo # Reseting base table t2:
delete from t2;
insert into t2 values (4),(7),(1),(3),(11);


--echo # Embedding view 'v2' inside 'v4':
create view v4 as (select * from v2 where b>3);
select * from v4;

--echo # Updating 'v4':
with cte1 as (select * from v4) update cte1 set b=20 where b>5;
select * from t2;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v4 where b>3) update cte1 set b=0 where b<9;
select * from t2;

--echo # Embedding v4 inside a DT (dt1):
with cte1 as (select * from (select * from v4) dt1) update cte1 set b=0 where b<7;
select * from t2;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from (select * from v4) dt1 where b>2) update cte1 set b=0 where b<7;
select * from t2;

--echo # Multiple CTE elements:
with cte1 as (select * from v4), cte2 as (select * from cte1)
update cte2 set b=11 where b>5;
select * from t2;

--echo # ... Adding where clause in specification of cte1:
with cte1 as (select * from v4 where b<15), cte2 as (select * from cte1)
update cte2 set b=11 where b>5;
select * from t2;

--echo # ... Adding where clause in specification of cte2:
with cte1 as (select * from v4 where b<15), cte2 as (select * from cte1 where b>3)
update cte2 set b=11 where b>2;
select * from t2;


--echo # Non-updatable CTEs with base tables only
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from t1 union select * from t2) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from t1 group by a) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from t1 group by a having count(*) >=1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select DISTINCT * from t1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from t1 limit 1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from t1 union select * from t2 limit 2) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select DISTINCT * from t1 union select * from t2) update cte1 set a=0;

--echo # Non-updatable CTEs with views containing DT and base table
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v1 union select * from v2) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v1 group by a) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v1 group by a having count(*) >=1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select DISTINCT * from v1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v1 limit 1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v1 union select * from v2 limit 2) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select DISTINCT * from v1 union select * from v2) update cte1 set a=0;

--echo # Non-updatable CTEs with Embedded views and Embedded DT views
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v3 union select * from v4) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v3 group by a) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v3 group by a having count(*) >=1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select DISTINCT * from v3) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v3 limit 1) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select * from v3 union select * from v4 limit 2) update cte1 set a=0;
--error ER_NON_UPDATABLE_TABLE
with cte1 as (select DISTINCT * from v3 union select * from v4) update cte1 set a=0;

--echo # Clearing:
drop table t1, t2;
drop view v1, v2, v3, v4;
