create table t1 (a int) engine=myisam;
insert into t1 values (3), (7), (1);
update (select a from t1) as t set a=10;
select * from t1;
create view v1 as select a from t1;
show create view v1;
update v1 set a=12;
select * from t1;
update (select * from t1) as t set a=14;
select * from t1;
update (select * from t1) as t set t.a=18 limit 1;
select * from t1;
update (select * from t1) as t set t.a=2 where a < 18;
select * from t1;
update (select * from (select * from t1) as t) as tt set tt.a=22 where a > 18;
select * from t1;
update (select * from (select * from t1) as t where t.a > 20) as tt set tt.a=24; 
select * from t1;
create view v2 as select * from v1 where v1.a < 10;
create view v3 as select * from v2;
update t1 set a=10 limit 1;
select * from t1;
update t1 set a=7  where a > 10;
select * from t1;
update v3 set a=6;
select * from t1;
update (select * from (select * from t1) as t where t.a < 10) as tt set tt.a=2;
select * from t1;
update t1 set a=5 where a < 10 limit 1;
select * from t1;
update (select * from (select * from t1 where t1.a > 2) as t where t.a < 10) as tt set tt.a=4; 
select * from t1;
create view v4 as select * from (select * from t1) t where t.a < 10;
show create view v4;
select * from v4;
create view v5 as select a as b from v1 where v1.a < 10;
show create view v5;
drop view v4;
create view v4 as select * from (select a as b from t1) t where t.b < 10;
show create view v4;
select * from v4;
delete from t1;
insert into t1 values (3),(7),(1);
update v4 set v4.b=12 where v4.b > 5;
select * from t1;
update v5 set v5.b=12 where v5.b < 3;
select * from t1;
create view v6 as select * from (select a as b from t1) t where t.b < 10 with check option;
show create view v6;
create view v7 as select a as b from v1 where v1.a < 10 with check option;
show create view v7;
show create view v7;
-- error ER_VIEW_CHECK_FAILED
update v7 set v7.b=20 where v7.b < 5;
-- error ER_VIEW_CHECK_FAILED
update v6 set v6.b=15 where v6.b < 5;
update (select * from v6 where v6.b < 5) t set t.b=7;
select * from t1;
drop view v1,v2,v3,v4,v5,v6,v7;
drop table t1;

create table t1 (a int);
insert into t1 values (1),(2),(3),(4),(7),(10);
create table t2 (b int);
insert into t2 values (4),(7),(1),(3),(11);
create view v1 as (select * from t1);
create view v2 as (select * from (select * from t2) dt1 where b < 10);
create view v3 as (select * from v1 where a<7);
create view v4 as (select * from v2 where b>3);

--echo # A DT is non-updatable if its specification is merged, which happens when
--echo # specification has UNION / GROUP BY / DISTINCT / LIMIT / HAVING.
--echo # Following queries try to non-updability of DT when we have a base table.
--error ER_NON_UPDATABLE_TABLE
update (select * from t1 union select * from t2) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from t1 group by a) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from t1 group by a having count(*) >=1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select DISTINCT * from t1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from t1 limit 1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from t1 union select * from t2 limit 2) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select DISTINCT * from t1 union select * from t2) dt1 set a=0;

--echo # Checking for views with a base table.
--error ER_NON_UPDATABLE_TABLE
update (select * from v1 union select * from v2) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v1 group by a) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v1 group by a having count(*) >=1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select DISTINCT * from v1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v1 limit 1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v1 union select * from v2 limit 2) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select DISTINCT * from v1 union select * from v2) dt1 set a=0;

--echo # When view is updatable but select in which it's used is not
--error ER_NON_UPDATABLE_TABLE
update (select * from v3 union select * from v4) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v3 group by a) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v3 group by a having count(*) >=1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select DISTINCT * from v3) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v3 limit 1) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select * from v3 union select * from v4 limit 2) dt1 set a=0;
--error ER_NON_UPDATABLE_TABLE
update (select DISTINCT * from v3 union select * from v4) dt1 set a=0;

--echo # Checking updatability of views when it's speicfication is materialised
create view v5 as (select * from t1 union select * from t2);
select * from v5;
create view v6 as (select * from t1 group by a);
select * from v6;
create view v7 as (select * from t1 group by a having count(*) >=1);
select * from v7;
create view v8 as (select DISTINCT * from t1);
select * from v8;
create view v9 as (select * from t1 limit 1);
select * from v9;
create view v10 as (select * from t1 union select * from t2 limit 2);
select * from v10;
create view v11 as (select DISTINCT * from t1 union select * from t2);
select * from v11;
--error ER_NON_UPDATABLE_TABLE
update v5 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v6 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v7 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v8 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v9 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v10 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v11 set a=0;
drop view v5, v6, v7, v8, v9, v10, v11;

--echo # Checking above given cases with a view instead of a base table
create view v5 as (select * from v1 union select * from v2);
select * from v5;
create view v6 as (select * from v1 group by a);
select * from v6;
create view v7 as (select * from v1 group by a having count(*) >=1);
select * from v7;
create view v8 as (select DISTINCT * from v1);
select * from v8;
create view v9 as (select * from v1 limit 1);
select * from v9;
create view v10 as (select * from v1 union select * from v2 limit 2);
select * from v10;
create view v11 as (select DISTINCT * from v1 union select * from v2);
select * from v11;
--error ER_NON_UPDATABLE_TABLE
update v5 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v6 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v7 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v8 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v9 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v10 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v11 set a=0;
drop view v5, v6, v7, v8, v9, v10, v11;

--echo # Checking with views containing DT inside them
create view v5 as (select * from v3 union select * from v4);
select * from v5;
create view v6 as (select * from v3 group by a);
select * from v6;
create view v7 as (select * from v3 group by a having count(*) >=1);
select * from v7;
create view v8 as (select DISTINCT * from v3);
select * from v8;
create view v9 as (select * from v3 limit 1);
select * from v9;
create view v10 as (select * from v3 union select * from v4 limit 2);
select * from v10;
create view v11 as (select DISTINCT * from v3 union select * from v4);
select * from v11;
--error ER_NON_UPDATABLE_TABLE
update v5 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v6 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v7 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v8 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v9 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v10 set a=0;
--error ER_NON_UPDATABLE_TABLE
update v11 set a=0;
drop view v5, v6, v7, v8, v9, v10, v11;

--echo # Non-updatable tables with only non-updatable fields
--error ER_NON_UPDATABLE_TABLE
update (select a+1 as a1 from t1) dt1 set a1=0;
-- error ER_BAD_FIELD_ERROR
update (select a+1 as a1 from t1 where a1>0) dt1 set a1=0;
-- error ER_BAD_FIELD_ERROR
update (select a+1 as a1 from t1 where a1>0) dt1 set a1=0 where a1<10;
--
update (select a+1 as a1 from (select * from t1) dt1 ) dt2 set a1=0 where a1<10;
update (select a+1 as a1 from (select * from t1 where a>0) dt1) dt2
set a1=0 where a1<10;

--echo # Tables with updatable and non-updatable fields with base table only
create table t3 (a int, b int);
insert into t3 (1,3),(8,3),(11,11);
--error
update (select a+1 as a1, b from t1) dt1 set a1=0;
update (select a+1 as a1, b from t1) dt1 set b=0;
--error
update (select a+1 as a1, b from t1 where a1>0) dt1 set a1=0;
--error
update (select a+1 as a1, b from t1 where b>3) dt1 set a1=0;
update (select a+1 as a1, b from t1 where b>3) dt1 set b=0;

create view v5 as (select a+1 as a1, b from t3);
select * from v5;
create view v6 as (select a+1 as a1, b from t3 where b>0);
select * from v6;

--echo # Views with updatable and non-updatable fields
--error
update v5 set a1=0;
update v5 set b=0;
--error
update v6 set a1=0;
update v6 set b=0;

--echo # Views inside DTs with updatable and non-updatable fields
update (select a1, b from v5) dt1 set a1=0;
update (select a1, b from v5) dt1 set b=0;
--error
update (select a1, b from v5 where a1>0) dt1 set a1=0;
--error
update (select a1, b from v5 where b>3) dt1 set a1=0;
update (select a1, b from v5 where b>3) dt1 set b=0;
update (select a1, b from v6) dt1 set a1=0;
update (select a1, b from v6) dt1 set b=0;
--error
update (select a1, b from v6 where a1>0) dt1 set a1=0;
--error
update (select a1, b from v6 where b>3) dt1 set a1=0;
update (select a1, b from v6 where b>3) dt1 set b=0;
drop view v5, v6;

create view v5 as (select a+1 as a1, b from (select * from t3) dt1);
select * from v5;
create view v6 as (select a+1 as a1, b from (select * from t3) dt1 where b>0);
select * from v6;

--echo # Views with DTs inside with updatable and non-updatable fields
--error
update v5 set a1=0;
update v5 set b=0;
--error
update v6 set a1=0;
update v6 set b=0;

--echo # Clearing up:
drop table t1, t2;
drop view v1, v2, v3, v4;
